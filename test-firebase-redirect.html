<!DOCTYPE html>
<html>
<head>
    <title>Teste Firebase Redirect</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        button { padding: 10px 20px; margin: 5px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; font-family: monospace; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>üî• Teste Firebase Redirect</h1>
    
    <button onclick="testRedirect()">Testar Redirect</button>
    <button onclick="clearLogs()">Limpar Logs</button>
    
    <div id="log" class="log"></div>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCFUE9xXtbjJGQTz4nGgveWJx6DuhOqD2U",
            authDomain: "unobix-oauth-a69cd.firebaseapp.com",
            projectId: "unobix-oauth-a69cd",
            storageBucket: "unobix-oauth-a69cd.firebasestorage.app",
            messagingSenderId: "1067767347117",
            appId: "1:1067767347117:web:26e1193bdef8e264409324"
        };
        
        let auth = null;
        let provider = null;
        
        function log(msg, type = 'info') {
            const div = document.getElementById('log');
            const p = document.createElement('p');
            p.className = type;
            p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            div.appendChild(p);
            div.scrollTop = div.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function loadFirebase() {
            return new Promise((resolve, reject) => {
                if (typeof firebase !== 'undefined') {
                    log('‚úÖ Firebase j√° carregado', 'success');
                    resolve();
                    return;
                }
                
                log('üî• Carregando Firebase SDK...', 'info');
                
                const script1 = document.createElement('script');
                script1.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js';
                
                script1.onload = () => {
                    log('‚úÖ Firebase App carregado', 'success');
                    
                    const script2 = document.createElement('script');
                    script2.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js';
                    
                    script2.onload = () => {
                        log('‚úÖ Firebase Auth carregado', 'success');
                        resolve();
                    };
                    
                    script2.onerror = () => reject(new Error('Falha ao carregar Firebase Auth'));
                    document.head.appendChild(script2);
                };
                
                script1.onerror = () => reject(new Error('Falha ao carregar Firebase App'));
                document.head.appendChild(script1);
            });
        }
        
        async function initFirebase() {
            try {
                log('üîß Inicializando Firebase...', 'info');
                
                // Inicializar
                firebase.initializeApp(firebaseConfig);
                log('‚úÖ Firebase inicializado', 'success');
                
                // Configurar auth
                auth = firebase.auth();
                provider = new firebase.auth.GoogleAuthProvider();
                
                provider.addScope('email');
                provider.addScope('profile');
                provider.setCustomParameters({ prompt: 'select_account' });
                
                log('‚úÖ Auth e Provider configurados', 'success');
                
                // Configurar persist√™ncia
                await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                log('‚úÖ Persist√™ncia configurada', 'success');
                
                return true;
            } catch (error) {
                log(`‚ùå Erro ao inicializar: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testRedirect() {
            try {
                log('--- INICIANDO TESTE DE REDIRECT ---', 'info');
                
                // 1. Carregar Firebase
                await loadFirebase();
                
                // 2. Inicializar
                const initialized = await initFirebase();
                if (!initialized) {
                    throw new Error('Firebase n√£o inicializado');
                }
                
                // 3. Verificar configura√ß√£o
                log(`üìã Configura√ß√£o atual:`, 'info');
                log(`   - authDomain: ${firebaseConfig.authDomain}`, 'info');
                log(`   - Dom√≠nio atual: ${window.location.hostname}`, 'info');
                log(`   - URL completa: ${window.location.href}`, 'info');
                
                // 4. Testar redirect
                log('üîÑ Iniciando signInWithRedirect...', 'info');
                
                // Salvar flag
                sessionStorage.setItem('testRedirect', 'true');
                
                // IMPORTANTE: signInWithRedirect deve redirecionar IMEDIATAMENTE
                // Se n√£o redirecionar, h√° um problema
                auth.signInWithRedirect(provider);
                
                // Se chegou aqui, o redirect n√£o funcionou
                log('‚ùå signInWithRedirect N√ÉO redirecionou!', 'error');
                log('‚ö†Ô∏è O Firebase deveria ter redirecionado a p√°gina', 'error');
                
                // Tentar diagn√≥stico
                diagnoseRedirectIssue();
                
            } catch (error) {
                log(`üí• Erro no teste: ${error.message}`, 'error');
            }
        }
        
        function diagnoseRedirectIssue() {
            log('üîç Diagnosticando problema...', 'info');
            
            // Verificar se o dom√≠nio est√° autorizado
            const currentDomain = window.location.hostname;
            const authDomain = firebaseConfig.authDomain;
            
            log(`   - authDomain configurado: ${authDomain}`, 'info');
            log(`   - Dom√≠nio atual: ${currentDomain}`, 'info');
            
            // Verificar se √© localhost
            if (currentDomain === 'localhost' || currentDomain === '127.0.0.1') {
                log('‚ö†Ô∏è Usando localhost - verifique se est√° autorizado no Firebase Console', 'warning');
            }
            
            // Verificar se o dom√≠nio est√° na lista de autorizados
            if (authDomain && !authDomain.includes(currentDomain) && 
                authDomain !== 'unobix-oauth-a69cd.firebaseapp.com') {
                log('‚ö†Ô∏è authDomain n√£o corresponde ao dom√≠nio atual', 'warning');
            }
            
            // Sugerir verifica√ß√£o no Firebase Console
            log('üí° Verifique no Firebase Console:', 'info');
            log('   1. Acesse https://console.firebase.google.com', 'info');
            log('   2. Projeto: unobix-oauth-a69cd', 'info');
            log('   3. Authentication ‚Üí Sign-in method ‚Üí Google', 'info');
            log('   4. Adicione o dom√≠nio: crypto-asteroid-rush-production.up.railway.app', 'info');
        }
        
        // Verificar se voltou de redirect
        if (sessionStorage.getItem('testRedirect') === 'true') {
            log('üîÑ Retornando de redirect...', 'info');
            sessionStorage.removeItem('testRedirect');
            
            setTimeout(async () => {
                try {
                    await loadFirebase();
                    await initFirebase();
                    
                    const result = await auth.getRedirectResult();
                    
                    if (result.user) {
                        log(`‚úÖ Redirect BEM-SUCEDIDO! Usu√°rio: ${result.user.email}`, 'success');
                    } else {
                        log('‚ÑπÔ∏è Nenhum resultado de redirect', 'info');
                    }
                } catch (error) {
                    log(`‚ùå Erro ao verificar redirect: ${error.message}`, 'error');
                }
            }, 1000);
        }
        
        log('‚úÖ P√°gina de teste carregada', 'success');
    </script>
</body>
</html>